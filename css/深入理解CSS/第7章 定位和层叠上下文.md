# 第 7 章 定位和层叠上下文

| 关键字     | 定位基点                       | 脱离文档流 | `top, right, bottom, left` 设置这四个值还隐式地定义了元素的宽高 |
| :--------- | :----------------------------- | :--------- | :-------------------------------------------------------------- |
| `static`   | /                              | 否         | /                                                               |
| `relative` | 元素没有定位时的位置           | 否         | 否                                                              |
| `absolute` | 最近的非 `static` 定位祖先元素、根元素（兜底）| 是         | 是                                                              |
| `fixed`    | `viewport`                     | 是         | 是                                                              |
| `sticky`   | 最近的滚动祖先元素和最近的块祖先元素、根元素（兜底）| 否         | /                                                               |

`position` 属性用于指定元素在文档中的定位方式，**`top, right, bottom, left` 则决定了该元素的最终位置**。

定位允许你从正常的文档流布局中取出元素，并使它们具有不同的行为，例如：放在另一个元素的上面，或者始终保持在浏览器视窗内的同一位置。

## 静态定位 `static`

默认值，没有定位，元素出现在正常文档流。此时元素位置是浏览器决定的，所以 `top, right, bottom, left` 和 `z-index` 属性无效。

## 相对定位 `relative`

1. 相对于元素没有定位时的位置

2. 元素**未脱离正常文档流**，仍然保留元素原本在文档流中的位置，不影响其他元素的偏移。（其他元素还是围绕着被移走元素的初始位置）

3. 即时没有设置 `width/height`，`top, right, bottom, left` 也不会改变元素大小

4. `top 和 bottom` 不能一起用，`bottom` 会被忽略。`left 和 right` 不能一起用，`right` 会被忽略。

![alt text](https://github.com/yaoshaohua/markdowndocs/blob/main/assets/css/7-4-1.png?raw=true)

## 绝对定位 `absolute`

1. 相对于**最近的非 `static` 祖先元素**，非 `static` 祖先元素不存在时，则相对于根元素 `body`

2. 元素**脱离正常文档流**，并不为元素预留空间

3. `top, right, bottom, left` 设置这四个值还隐式地定义了元素的宽高

## 固定定位 `fixed`

元素的位置在屏幕滚动时不会改变

1. 相对于**视口（viewport）**

2. 元素**脱离正常文档流**，并不为元素预留空间

3. `top, right, bottom, left` 设置这四个值还隐式地定义了元素的宽高

4. 创建新的层叠上下文

## 粘性定位 `sticky`

`relative` 和 `fixed` 的结合，在元素滚动到距离祖先元素小于设置的阈值之前，元素为相对定位，之后为固定定位，

1. 相对于最近的滚动祖先元素（`overflow` 是 `hidden、scroll、auto、overlay`）和最近的块级祖先元素

2. 元素**未脱离正常文档流**，仍然保留元素原本在文档流中的位置，不影响其他元素的偏移。

3. 必须指定 `top, right, bottom, left` 四个阈值其中之一，才可使粘性定位生效，否则等同于相对定位 `relative`

   - 水平滚动必须指定 `left/right`，垂直滚动必须指定 `top/bottom`

   - `sticky` 的 `top, right, bottom, left` 并不是传统定位的意义而是 `sticky` 定位状态改变的阈值

4. **区别于 `fixed`，作用范围不会超出父元素，如果父元素完全脱离视口（完全不可见），粘性元素也不可见，切换回相对定位**

5. 创建新的层叠上下文

在 `viewport` 视口滚动到元素 `top` 距离小于 `10px` 之前，元素为相对定位。之后，元素将固定在与顶部距离 `10px` 的位置，直到 `viewport` 视口回滚到阈值以下

```css
#one {
  position: sticky;
  top: 10px;
}
```

## 层叠上下文和 `z-index`

当把一个元素从文档流中移除时，我们就需要管理之前由文档流处理的所有事情了：

- 首先要确保元素不会不小心跑到浏览器视口之外，导致用户会看不到元素

- 其次要保证元素不会不小心挡住重要内容

- 最后还有层叠的问题，在同一页面定位多个元素时，可能会遇到两个不同定位的元素重叠的现象

### 理解渲染过程和层叠顺序

渲染树，代表了每个元素的视觉样式和位置，同时还决定了**浏览器绘制元素的顺序**。顺序很重要，如果元素刚好重叠，后绘制的元素就会出现在先绘制的元素前面（上面）。

- 通常情况下（使用定位之前），元素在 `HTML` 里出现的顺序决定了绘制顺序

- 定位元素时，这种行为会改变。浏览器会**先绘制所有非定位的元素，然后绘制定位元素**。默认情况下，所有的定位元素会出现在非定位元素前面

### `z-index` 控制层叠顺序

`z` 表示的是笛卡尔 `x-y-z` 坐标系里的深度方向

`z-index` 属性会指定：

1. 元素在当前层叠上下文中的层叠等级

2. 元素是否会创建局部层叠上下文

取值：

- `auto`：元素在当前层叠上下文的层叠等级是 `0`。元素不会创建一个新的局部层叠上下文。

- `<integer>`：元素在当前层叠上下文的层叠等级就是 `<integer>`。元素还会创建一个局部层叠上下文。这意味着该元素的后代元素不会和该元素的外部元素比较 `z-index`。

注意：

- `z-index` 只在定位元素上生效，不能用它控制 `static` 元素

- 子级层叠上下文的 `z-index` 值只在父级中才有意义

### 理解层叠上下文

层叠上下文负责决定哪些元素出现在另一些元素前面。

一个层叠上下文包含一个元素或者由浏览器一起绘制的一组元素。其中一个元素会作为层叠上下文的根，比如给一个定位元素添加 `z-index`，它就会变成一个新的层叠上下文的根。

所有层叠上下文内的元素会按照以下顺序，从后到前叠放：

- 层叠上下文的根

- `z-index` 为负的定位元素（及其子元素）

- `static` 元素

- `z-index` 为 `auto` 或者 `0` 的定位元素（及其子元素）

- `z-index` 为正的定位元素（及其子元素）

创建层叠上下文主要的方式：

- 文档根节点（`<html>`）也会给整个页面创建一个顶级的层叠上下文

- 给定位元素添加加 `z-index`

- `opacity` 小于 `1`

- `transform` 或者 `filter` 属性不为 `none`

### 疑问

1. 层叠上下文对渲染的影响？？？

2. 层叠上下文顺序、渲染顺序的关系？？？

## 应用

1. `position: fixed` 和 `position: sticky` 的区别

- 表现不同，`fixed` 始终固定在指定位置，`sticky` 表现包含 `relative` 和 `fixed` 两种状态

- 定位基点不同，`fixed` 相对于 `viewport`，`sticky` 相对于最近的滚动祖先元素

- `fixed` 脱离文档流、其他元素定位时会当作 `fixed` 元素不存在，`sticky` 没有脱离文档流、其他元素依然围绕 `sticky` 元素正常文档流的位置排列

- `sticky` 必须指定 `top, right, bottom, left` 之一

- `sticky` 受限于父元素，父元素离开视口，`sticky` 也跟随离开
